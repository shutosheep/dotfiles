#! /bin/sh

# This script will let you choose wallpaper with sxiv, then use pywal to create
# color scheme of it. It will then add variables to ~/.Xresources file for dwm
# and dmenu

wallpaper=$(sxiv -to ~/pix/wp/*)

if [ -z $wallpaper ]; then
    exit 0
fi

cp $wallpaper ~/pix/wallpaper

# Set wallpaper
feh --no-fehbg --bg-fill ~/pix/wallpaper

# Delete the previous wallpaper theme cache
wal -c

# Create color scheme for current background
wal -n -i ~/pix/wallpaper

# Copy pywal Xresources to home directory
cp  ~/.cache/wal/colors.Xresources ~/.Xresources

m="2"
b="0"
w="15"

# Colors
main=$(grep *color$m: ~/.Xresources | awk '{print $2}')
black=$(grep *color$b: ~/.Xresources | awk '{print $2}')
white=$(grep *color$w: ~/.Xresources | awk '{print $2}')

# Convert hex color to rgb
hexcolor=$(echo $main | tr '[:lower:]' '[:upper:]')

a=`echo $hexcolor | cut -c-2`
b=`echo $hexcolor | cut -c3-4`
c=`echo $hexcolor | cut -c5-6`

r=`echo "ibase=16; $a" | bc`
g=`echo "ibase=16; $b" | bc`
b=`echo "ibase=16; $c" | bc`

sum=$((r + g + b))

# If the sum is brighter or darker
if [ $sum -ge 256 ]; then
    echo -e "\n\ndwm.normbordercolor: $black\ndwm.normbgcolor: $black\ndwm.normfgcolor: $white\ndwm.selbordercolor: $main\ndwm.selbgcolor: $main\ndwm.selfgcolor: $black" >> ~/.Xresources
    echo -e "\ndmenu.normbgcolor: $black\ndmenu.normfgcolor: $white\ndmenu.selbgcolor: $main\ndmenu.selfgcolor: $black" >> ~/.Xresources
else
    echo -e "\n\ndwm.normbordercolor: $black\ndwm.normbgcolor: $black\ndwm.normfgcolor: $white\ndwm.selbordercolor: $main\ndwm.selbgcolor: $main\ndwm.selfgcolor: $white" >> ~/.Xresources
    echo -e "\ndmenu.normbgcolor: $black\ndmenu.normfgcolor: $white\ndmenu.selbgcolor: $main\ndmenu.selfgcolor: $white" >> ~/.Xresources
fi

# Reload Xresources
xrdb ~/.Xresources

# Reload it on dwm
xdotool key super+F12
