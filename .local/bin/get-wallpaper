#! /bin/sh

# This script will download wallpapers from wallhaven using its API.
# Documentation: https://wallhaven.cc/help/api

# Import pywal colors
. "${HOME}/.cache/wal/colors.sh"

walldir="$HOME/pix/dl"

query=$(echo "" | dmenu -p "Search wallhaven: ")

# Exit if none chosen
[ -z "$query" ] && exit

sortoptions="date_added\nrelevance\nrandom\nviews\nfavorites\ntoplist"
sorting=$(echo -e $sortoptions | dmenu -p "Sort by: ")

# Send notification
dunstify -h string:bgcolor:$color0 -h string:fgcolor:$color15 -h string:frcolor:$color2 -h string:hlcolor:$color2 -t 5000 "‚¨áÔ∏è Downloading wallpapers..." "(This might take few minutes)"

# Download wallpapers
for i in $(seq 1 3);
do
    curl -s https://wallhaven.cc/api/v1/search\?atleast\=1920x1080\&sorting\=$sorting\&q\=$query\&page\=$i > get-wallpaper_tmp.txt
    url=$(cat get-wallpaper_tmp.txt | jq '.' | grep -Eoh "https:\/\/w\.wallhaven.cc\/full\/.*(jpg|png)\b")
    wget -nc -P $walldir $url
done

# Send notification
dunstify -h string:bgcolor:$color0 -h string:fgcolor:$color15 -h string:frcolor:$color2 -h string:hlcolor:$color2 -t 5000 "üëç Download finished!!"

# Remove tmp file
rm get-wallpaper_tmp.txt

# Use sxiv to view and remove the downloaded wallpapers
sxiv -t $walldir/*

# Move to wallpaper directory
mv $walldir/* ~/pix/wp/
